@model AppGambit.ViewModels.EditApplicationViewModel
@{
    ViewData["Title"] = "Редактировать приложение";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-edit me-2"></i>Редактировать приложение
                    </h3>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" method="post" enctype="multipart/form-data">
                        <input type="hidden" asp-for="Id" />
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <!-- Основная информация -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">Основная информация</h5>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="Name" class="form-label">Название приложения *</label>
                                <input asp-for="Name" class="form-control" placeholder="Введите название приложения" />
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="Version" class="form-label">Версия *</label>
                                <input asp-for="Version" class="form-control" placeholder="1.0.0" />
                                <span asp-validation-for="Version" class="text-danger"></span>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label asp-for="Description" class="form-label">Краткое описание *</label>
                                <textarea asp-for="Description" class="form-control" rows="3" 
                                          placeholder="Краткое описание приложения (до 500 символов)"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                                <div class="form-text">Максимум 500 символов</div>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label asp-for="DetailedDescription" class="form-label">Подробное описание</label>
                                <textarea asp-for="DetailedDescription" class="form-control" rows="6" 
                                          placeholder="Подробное описание функций, особенностей и возможностей приложения"></textarea>
                                <span asp-validation-for="DetailedDescription" class="text-danger"></span>
                                <div class="form-text">Максимум 2000 символов</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="Category" class="form-label">Категория</label>
                                <select asp-for="Category" class="form-select">
                                    <option value="">Выберите категорию</option>
                                    <option value="Игры">Игры</option>
                                    <option value="Утилиты">Утилиты</option>
                                    <option value="Образование">Образование</option>
                                    <option value="Бизнес">Бизнес</option>
                                    <option value="Графика">Графика</option>
                                    <option value="Мультимедиа">Мультимедиа</option>
                                    <option value="Разработка">Разработка</option>
                                    <option value="Безопасность">Безопасность</option>
                                    <option value="Интернет">Интернет</option>
                                    <option value="Системные">Системные</option>
                                    <option value="Другое">Другое</option>
                                </select>
                                <span asp-validation-for="Category" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="TagsString" class="form-label">Теги</label>
                                <input type="text" id="tags" class="form-control"
                                       placeholder="Введите теги через запятую" />
                                <div class="form-text">Например: игра, аркада, 2D</div>
                                <div id="tagsContainer" class="mt-2"></div>
                                <input type="hidden" asp-for="TagsString" id="tagsHidden" />
                                <span asp-validation-for="TagsString" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Файлы -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">Файлы</h5>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="IconFile" class="form-label">Иконка приложения</label>
                                @if (!string.IsNullOrEmpty(Model.CurrentIconUrl))
                                {
                                    <div class="mb-2">
                                        <img src="@Model.CurrentIconUrl" class="img-thumbnail"
                                             style="max-width: 100px; max-height: 100px;" alt="Текущая иконка">
                                        <div class="form-text">Текущая иконка</div>
                                    </div>
                                }
                                <input asp-for="IconFile" type="file" id="iconFile" class="form-control"
                                       accept="image/*,.ico" />
                                <div class="form-text">Рекомендуемый размер: 128x128 пикселей. Форматы: JPG, PNG, GIF, ICO</div>
                                <div id="iconPreview" class="mt-2"></div>
                                <span asp-validation-for="IconFile" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="AppFile" class="form-label">Файл приложения</label>
                                @if (!string.IsNullOrEmpty(Model.CurrentDownloadUrl))
                                {
                                    <div class="mb-2">
                                        <div class="alert alert-info">
                                            <i class="fas fa-file me-2"></i>
                                            Текущий файл загружен
                                        </div>
                                    </div>
                                }
                                <input asp-for="AppFile" type="file" id="appFile" class="form-control"
                                       accept=".exe,.msi,.zip,.rar,.7z,.apk" />
                                <div class="form-text">Поддерживаемые форматы: EXE, MSI, ZIP, RAR, 7Z, APK (необязательно)</div>
                                <div id="fileInfo" class="mt-2"></div>
                                <span asp-validation-for="AppFile" class="text-danger"></span>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label class="form-label">Текущие скриншоты</label>
                                @if (Model.CurrentScreenshots != null && Model.CurrentScreenshots.Any())
                                {
                                    <div id="currentScreenshots" class="row g-2 mb-3">
                                        @for (int i = 0; i < Model.CurrentScreenshots.Count; i++)
                                        {
                                            <div class="col-md-3 col-sm-4 col-6">
                                                <div class="position-relative">
                                                    <img src="@Model.CurrentScreenshots[i]" class="img-thumbnail w-100"
                                                         alt="Скриншот @(i + 1)" style="height: 100px; object-fit: cover;">
                                                    <div class="position-absolute top-0 end-0 p-1">
                                                        <button type="button" class="btn btn-sm btn-danger" 
                                                                onclick="markScreenshotForDeletion('@Model.CurrentScreenshots[i]', this)" 
                                                                title="Удалить">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                
                                <label asp-for="Screenshots" class="form-label">Добавить новые скриншоты</label>
                                <input asp-for="Screenshots" type="file" id="screenshots" class="form-control"
                                       accept="image/*" multiple />
                                <div class="form-text">Можно загрузить несколько изображений. Форматы: JPG, PNG, GIF, ICO</div>
                                <div id="screenshotsPreview" class="mt-2 row g-2"></div>
                                <span asp-validation-for="Screenshots" class="text-danger"></span>
                                
                                <!-- Скрытые поля для удаления скриншотов -->
                                <div id="screenshotsToDeleteContainer"></div>
                            </div>
                        </div>

                        <!-- Кнопки -->
                        <div class="d-flex justify-content-between">
                            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Отмена
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Сохранить изменения
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tagsInput = document.getElementById('tags');
            const tagsContainer = document.getElementById('tagsContainer');
            const tagsHidden = document.getElementById('tagsHidden');
            const iconFile = document.getElementById('iconFile');
            const iconPreview = document.getElementById('iconPreview');
            const appFile = document.getElementById('appFile');
            const fileInfo = document.getElementById('fileInfo');
            const screenshots = document.getElementById('screenshots');
            const screenshotsPreview = document.getElementById('screenshotsPreview');
            
            let tags = [];
            let screenshotsToDelete = [];

            // Инициализация существующих тегов
            const existingTags = '@Html.Raw(Model.TagsString ?? "")';
            if (existingTags) {
                tags = existingTags.split(',').map(t => t.trim()).filter(t => t);
                updateTagsDisplay();
            }

            // Обработка тегов
            tagsInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    addTag();
                }
            });

            tagsInput.addEventListener('blur', addTag);

            function addTag() {
                const value = tagsInput.value.trim();
                if (value && !tags.includes(value)) {
                    tags.push(value);
                    updateTagsDisplay();
                    tagsInput.value = '';
                }
            }

            function removeTag(tag) {
                tags = tags.filter(t => t !== tag);
                updateTagsDisplay();
            }

            function updateTagsDisplay() {
                tagsContainer.innerHTML = tags.map(tag =>
                    `<span class="tag tag-primary tag-removable">
                        ${tag}
                        <button type="button" class="tag-remove" onclick="removeTag('${tag}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </span>`
                ).join('');
                tagsHidden.value = tags.join(',');
            }

            // Глобальная функция для удаления тегов
            window.removeTag = removeTag;

            // Предпросмотр иконки
            iconFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        iconPreview.innerHTML = `
                            <img src="${e.target.result}" class="img-thumbnail" 
                                 style="max-width: 100px; max-height: 100px;" alt="Предпросмотр иконки">
                        `;
                    };
                    reader.readAsDataURL(file);
                } else {
                    iconPreview.innerHTML = '';
                }
            });

            // Информация о файле приложения
            appFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                    fileInfo.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-file me-2"></i>
                            <strong>${file.name}</strong><br>
                            Размер: ${sizeMB} МБ
                        </div>
                    `;
                } else {
                    fileInfo.innerHTML = '';
                }
            });

            // Предпросмотр новых скриншотов
            let screenshotFiles = [];
            
            screenshots.addEventListener('change', function(e) {
                screenshotFiles = Array.from(e.target.files);
                updateScreenshotsPreview();
            });
            
            function updateScreenshotsPreview() {
                screenshotsPreview.innerHTML = '';
                
                screenshotFiles.forEach((file, index) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const col = document.createElement('div');
                            col.className = 'col-md-3 col-sm-4 col-6 mb-2';
                            col.innerHTML = `
                                <div class="position-relative">
                                    <img src="${e.target.result}" class="img-thumbnail w-100"
                                         alt="Новый скриншот ${index + 1}" style="height: 100px; object-fit: cover;">
                                    <div class="position-absolute top-0 end-0 p-1">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="removeNewScreenshot(${index})" title="Удалить">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="position-absolute bottom-0 start-0 bg-success text-white px-2 py-1 small">
                                        Новый
                                    </div>
                                </div>
                            `;
                            screenshotsPreview.appendChild(col);
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                updateFileInput();
            }
            
            function removeNewScreenshot(index) {
                screenshotFiles.splice(index, 1);
                updateScreenshotsPreview();
            }
            
            function updateFileInput() {
                const dt = new DataTransfer();
                screenshotFiles.forEach(file => dt.items.add(file));
                screenshots.files = dt.files;
            }

            // Функция для пометки скриншота на удаление
            window.markScreenshotForDeletion = function(screenshotUrl, button) {
                const container = button.closest('.col-md-3, .col-sm-4, .col-6');
                container.style.opacity = '0.5';
                button.innerHTML = '<i class="fas fa-undo"></i>';
                button.title = 'Отменить удаление';
                button.onclick = function() { unmarkScreenshotForDeletion(screenshotUrl, button, container); };
                
                screenshotsToDelete.push(screenshotUrl);
                updateScreenshotsToDeleteInputs();
            };

            // Функция для отмены удаления скриншота
            window.unmarkScreenshotForDeletion = function(screenshotUrl, button, container) {
                container.style.opacity = '1';
                button.innerHTML = '<i class="fas fa-times"></i>';
                button.title = 'Удалить';
                button.onclick = function() { markScreenshotForDeletion(screenshotUrl, button); };
                
                screenshotsToDelete = screenshotsToDelete.filter(url => url !== screenshotUrl);
                updateScreenshotsToDeleteInputs();
            };

            function updateScreenshotsToDeleteInputs() {
                const container = document.getElementById('screenshotsToDeleteContainer');
                container.innerHTML = '';
                screenshotsToDelete.forEach((url, index) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = `ScreenshotsToDelete[${index}]`;
                    input.value = url;
                    container.appendChild(input);
                });
            }
            
            // Глобальные функции
            window.removeNewScreenshot = removeNewScreenshot;
        });
    </script>
}