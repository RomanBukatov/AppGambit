@model AppGambit.Models.Application
@{
    ViewData["Title"] = Model.Name;
    var userRating = ViewBag.UserRating as AppGambit.Models.Rating;
}

<div class="container mt-4">
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    
    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="col-lg-8 mb-4">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 col-sm-4 col-md-3 text-center mb-3 mb-md-0">
                            @if (!string.IsNullOrEmpty(Model.IconUrl))
                            {
                                <img src="@Model.IconUrl" class="img-fluid rounded mb-3" alt="@Model.Name" style="max-height: 150px;">
                            }
                            else
                            {
                                <div class="bg-light rounded d-flex align-items-center justify-content-center mb-3" style="height: 150px;">
                                    <i class="fas fa-desktop fa-4x text-muted"></i>
                                </div>
                            }
                        </div>
                        <div class="col-12 col-sm-8 col-md-9">
                            <h1 class="h2 mb-2">@Model.Name</h1>
                            <p class="text-muted mb-3">@Model.Description</p>
                            
                            <div class="row g-2 g-sm-3 mb-3">
                                <div class="col-6 col-sm-6">
                                    <small class="text-muted d-block">–í–µ—Ä—Å–∏—è</small>
                                    <strong>@Model.Version</strong>
                                </div>
                                <div class="col-6 col-sm-6">
                                    <small class="text-muted d-block">–†–∞–∑–º–µ—Ä</small>
                                    <strong>@(Model.FileSize / 1024 / 1024) –ú–ë</strong>
                                </div>
                                <div class="col-6 col-sm-6">
                                    <small class="text-muted d-block">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</small>
                                    @if (!string.IsNullOrEmpty(Model.Category))
                                    {
                                        <span class="badge bg-primary">@Model.Category</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω–∞</span>
                                    }
                                </div>
                                <div class="col-6 col-sm-6">
                                    <small class="text-muted d-block">–°–∫–∞—á–∏–≤–∞–Ω–∏–π</small>
                                    <strong id="download-count">@Model.DownloadCount</strong>
                                </div>
                            </div>

                            <!-- –¢–µ–≥–∏ -->
                            @if (Model.Tags != null && Model.Tags.Any())
                            {
                                <div class="mb-3">
                                    <strong>–¢–µ–≥–∏:</strong>
                                    <div class="tags-container">
                                        @foreach (var tag in Model.Tags)
                                        {
                                            <a href="@Url.Action("Index", "Applications", new { search = tag })" class="tag">#@tag</a>
                                        }
                                    </div>
                                </div>
                            }

                            <!-- –†–µ–π—Ç–∏–Ω–≥ -->
                            <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center mb-3">
                                <div class="rating me-3 mb-2 mb-sm-0">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= Model.AverageRating)
                                        {
                                            <i class="fas fa-star text-warning"></i>
                                        }
                                        else
                                        {
                                            <i class="far fa-star text-muted"></i>
                                        }
                                    }
                                    <span class="ms-2">@Model.AverageRating.ToString("F1") <span class="d-none d-sm-inline">(@Model.TotalRatings –æ—Ç–∑—ã–≤–æ–≤)</span><span class="d-inline d-sm-none">(@Model.TotalRatings)</span></span>
                                </div>
                                <div class="likes-dislikes">
                                    <span class="text-success me-2">
                                        <i class="fas fa-thumbs-up"></i> @Model.LikesCount
                                    </span>
                                    <span class="text-danger">
                                        <i class="fas fa-thumbs-down"></i> @Model.DislikesCount
                                    </span>
                                </div>
                            </div>

                            <!-- –ê–≤—Ç–æ—Ä -->
                            <div class="mb-3">
                                <strong>–ê–≤—Ç–æ—Ä:</strong>
                                <a href="/@Model.User.DisplayName" class="text-decoration-none">
                                    @Model.User.DisplayName
                                </a>
                                <small class="text-muted ms-2">@Model.CreatedAt.ToString("dd.MM.yyyy")</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ -->
            @if (!string.IsNullOrEmpty(Model.DetailedDescription))
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>–û–ø–∏—Å–∞–Ω–∏–µ</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">@Html.Raw(Model.DetailedDescription.Replace("\n", "<br>"))</p>
                    </div>
                </div>
            }

            <!-- –°–∫—Ä–∏–Ω—à–æ—Ç—ã -->
            @if (Model.Screenshots != null && Model.Screenshots.Any())
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-images me-2"></i>–°–∫—Ä–∏–Ω—à–æ—Ç—ã</h5>
                    </div>
                    <div class="card-body">
                        <div id="screenshotsCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner mb-3">
                                @for (int i = 0; i < Model.Screenshots.Count; i++)
                                {
                                    var screenshot = Model.Screenshots[i];
                                    <div class="carousel-item @(i == 0 ? "active" : "")">
                                        <img src="@screenshot" class="d-block w-100 rounded shadow-sm"
                                             alt="–°–∫—Ä–∏–Ω—à–æ—Ç @(i + 1)"
                                             style="max-height: 500px; object-fit: contain; cursor: pointer;"
                                             data-bs-toggle="modal" data-bs-target="#screenshotModal" data-bs-image="@screenshot" />
                                    </div>
                                }
                            </div>
                            
                            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã/–º–∏–Ω–∏–∞—Ç—é—Ä—ã -->
                            @if (Model.Screenshots.Count > 1)
                            {
                                <div class="carousel-thumbnails d-flex justify-content-center gap-2 mb-3">
                                    @for (int i = 0; i < Model.Screenshots.Count; i++)
                                    {
                                        var screenshot = Model.Screenshots[i];
                                        <div class="thumbnail-item @(i == 0 ? "active" : "")" 
                                             data-bs-target="#screenshotsCarousel" 
                                             data-bs-slide-to="@i">
                                            <img src="@screenshot" class="img-thumbnail"
                                                 style="width: 80px; height: 60px; object-fit: cover; cursor: pointer;"
                                                 alt="–ú–∏–Ω–∏–∞—Ç—é—Ä–∞ @(i + 1)" />
                                        </div>
                                    }
                                </div>
                            }
                            
                            <button class="carousel-control-prev" type="button" data-bs-target="#screenshotsCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">–ü—Ä–µ–¥—ã–¥—É—â–∏–π</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#screenshotsCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">–°–ª–µ–¥—É—é—â–∏–π</span>
                            </button>
                        </div>
                    </div>
                </div>
            }

            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0" id="comments-header"><i class="fas fa-comments me-2"></i>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (@Model.Comments.Count)</h5>
                </div>
                <div class="card-body">
                    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <form id="comment-form" onsubmit="addComment(event)" class="mb-4" data-ajax-form="true">
                            <input type="hidden" name="applicationId" value="@Model.Id" />
                            <div class="mb-3">
                                <textarea name="content" class="form-control" rows="3" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required maxlength="1000" id="commentTextarea"></textarea>
                                <div class="form-text text-end">
                                    <span id="commentCharCount">0</span>/1000 —Å–∏–º–≤–æ–ª–æ–≤
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" id="submitCommentBtn">
                                <i class="fas fa-paper-plane me-1"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </form>
                        <hr>
                    }

                    <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
                    @if (Model.Comments.Any())
                    {
                        @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                        {
                            <div class="comment mb-3 p-3 rounded" id="comment-@comment.Id" style="transition: all 0.3s ease; border: 1px solid transparent;">
                                <div class="d-flex">
                                    <!-- –ê–≤–∞—Ç–∞—Ä–∫–∞ -->
                                    <div class="flex-shrink-0 me-3">
                                        <a href="/@comment.User.DisplayName" style="text-decoration: none;">
                                            @if (!string.IsNullOrEmpty(comment.User.ProfileImageUrl))
                                            {
                                                <img src="@comment.User.ProfileImageUrl" class="rounded-circle" alt="@comment.User.DisplayName" style="width: 40px; height: 40px; object-fit: cover; cursor: pointer;">
                                            }
                                            else
                                            {
                                                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px; font-weight: bold; cursor: pointer;">
                                                    @comment.User.DisplayName.Substring(0, 1).ToUpper()
                                                </div>
                                            }
                                        </a>
                                    </div>
                                    
                                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="d-flex align-items-center">
                                                <strong><a href="/@comment.User.DisplayName" style="text-decoration: none; color: inherit;">@comment.User.DisplayName</a></strong>
                                                @if (comment.UserId == ViewBag.CurrentUserId)
                                                {
                                                    <span class="badge bg-primary ms-2">–ê–≤—Ç–æ—Ä</span>
                                                }
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                <small class="text-muted">
                                                    @comment.CreatedAt.ToString("dd.MM.yyyy HH:mm")
                                                    @if (comment.UpdatedAt > comment.CreatedAt.AddMinutes(1))
                                                    {
                                                        <span class="badge bg-secondary ms-1" title="–ò–∑–º–µ–Ω–µ–Ω–æ @comment.UpdatedAt.ToString("dd.MM.yyyy HH:mm")">
                                                            <i class="fas fa-edit"></i> –∏–∑–º–µ–Ω–µ–Ω–æ
                                                        </span>
                                                    }
                                                </small>
                                                @if (User.Identity?.IsAuthenticated == true && (comment.UserId == ViewBag.CurrentUserId || ViewBag.IsAdmin == true))
                                                {
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            @if (comment.UserId == ViewBag.CurrentUserId)
                                                            {
                                                                <li>
                                                                    <button class="dropdown-item" onclick="editComment(@comment.Id, '@Html.Raw(comment.Content.Replace("'", "\\'"))')">
                                                                        <i class="fas fa-edit me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                                                    </button>
                                                                </li>
                                                            }
                                                            <li>
                                                                <button class="dropdown-item text-danger" onclick="deleteComment(@comment.Id)">
                                                                    <i class="fas fa-trash me-2"></i>–£–¥–∞–ª–∏—Ç—å
                                                                </button>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                        
                                        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è -->
                                        <div class="comment-content">
                                            @{
                                                var isLongComment = comment.Content.Length > 300;
                                                var shortContent = isLongComment ? comment.Content.Substring(0, 300) + "..." : comment.Content;
                                            }
                                            
                                            @if (isLongComment)
                                            {
                                                <p class="mb-0 comment-text-short">@shortContent</p>
                                                <p class="mb-0 comment-text-full" style="display: none;">@comment.Content</p>
                                                <button class="btn btn-link btn-sm p-0 mt-1 text-primary expand-comment-btn" onclick="toggleComment(@comment.Id)">
                                                    <i class="fas fa-chevron-down me-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
                                                </button>
                                            }
                                            else
                                            {
                                                <p class="mb-0">@comment.Content</p>
                                            }
                                        </div>
                                        
                                        <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                                        <div class="comment-edit-form" style="display: none;">
                                            <form onsubmit="updateComment(event, @comment.Id)">
                                                <div class="mb-2">
                                                    <textarea class="form-control" rows="3" required maxlength="1000">@comment.Content</textarea>
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <button type="submit" class="btn btn-sm btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                                    <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit(@comment.Id)">–û—Ç–º–µ–Ω–∞</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center py-3">
                            <i class="fas fa-comment-slash fa-2x mb-2 d-block"></i>
                            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!
                        </p>
                    }
                </div>
            </div>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-lg-4">
            <!-- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5 class="card-title">–°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h5>
                    <div class="d-grid">
                        <a asp-action="Download" asp-route-id="@Model.Id" class="btn btn-success btn-lg" id="download-btn" data-author="@Model.User.DisplayName">
                            <i class="fas fa-download me-2"></i>–°–∫–∞—á–∞—Ç—å
                        </a>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        –†–∞–∑–º–µ—Ä: @(Model.FileSize / 1024 / 1024) –ú–ë
                    </small>
                </div>
            </div>

            <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∞) -->
            @if (User.Identity?.IsAuthenticated == true && ViewBag.CurrentUserId == Model.UserId)
            {
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º</h5>
                        <div class="d-grid gap-2">
                            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary btn-lg">
                                <i class="fas fa-edit me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                            <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger btn-lg">
                                <i class="fas fa-trash me-2"></i>–£–¥–∞–ª–∏—Ç—å
                            </a>
                        </div>
                    </div>
                </div>
            }

            <!-- –û—Ü–µ–Ω–∫–∞ -->
            @if (User.Identity?.IsAuthenticated == true)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">–û—Ü–µ–Ω–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h6>
                    </div>
                    <div class="card-body">
                        <form asp-action="Rate" method="post">
                            <input type="hidden" name="applicationId" value="@Model.Id" />
                            
                            <!-- –†–µ–π—Ç–∏–Ω–≥ –∑–≤–µ–∑–¥–∞–º–∏ -->
                            <div class="mb-3">
                                <label class="form-label">–†–µ–π—Ç–∏–Ω–≥:</label>
                                <div class="rating-input">
                                    @for (int i = 5; i >= 1; i--)
                                    {
                                        <input type="radio" name="value" value="@i" id="star@i"
                                               @(userRating != null && userRating.Value == i ? "checked" : "") />
                                        <label for="star@i" class="star">
                                            <i class="fas fa-star"></i>
                                        </label>
                                    }
                                </div>
                            </div>

                            <!-- –õ–∞–π–∫/–î–∏–∑–ª–∞–π–∫ -->
                            <div class="mb-3">
                                <label class="form-label">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" name="isLike" value="true" id="like" class="btn-check" 
                                           @(userRating != null && userRating.IsLike ? "checked" : "") />
                                    <label for="like" class="btn btn-outline-success">
                                        <i class="fas fa-thumbs-up me-1"></i>–ù—Ä–∞–≤–∏—Ç—Å—è
                                    </label>
                                    
                                    <input type="radio" name="isLike" value="false" id="dislike" class="btn-check" 
                                           @(userRating != null && !userRating.IsLike ? "checked" : "") />
                                    <label for="dislike" class="btn btn-outline-danger">
                                        <i class="fas fa-thumbs-down me-1"></i>–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è
                                    </label>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-star me-1"></i>–û—Ü–µ–Ω–∏—Ç—å
                            </button>
                        </form>
                    </div>
                </div>
            }

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                </div>
                <div class="card-body">
                    <div class="info-item mb-2">
                        <strong>–î–æ–±–∞–≤–ª–µ–Ω–æ:</strong><br>
                        <small class="text-muted">@Model.CreatedAt.ToString("dd MMMM yyyy")</small>
                    </div>
                    <div class="info-item mb-2">
                        <strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong><br>
                        <small class="text-muted">@Model.UpdatedAt.ToString("dd MMMM yyyy")</small>
                    </div>
                    <div class="info-item">
                        <strong>–í—Å–µ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π:</strong><br>
                        <small class="text-muted" id="total-downloads">@Model.DownloadCount</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ -->
<div class="modal fade" id="screenshotModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-custom">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body">
                @if (Model.Screenshots != null && Model.Screenshots.Count > 1)
                {
                    <button class="screenshot-nav prev" onclick="navigateScreenshot(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="screenshot-nav next" onclick="navigateScreenshot(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <div class="screenshot-indicator">
                        @for (int i = 0; i < Model.Screenshots.Count; i++)
                        {
                            <span class="dot @(i == 0 ? "active" : "")" data-index="@i" onclick="goToScreenshot(@i)"></span>
                        }
                    </div>
                }
                
                <div class="screenshot-info">
                    <span id="screenshotCounter">1 / @(Model.Screenshots?.Count ?? 1)</span>
                </div>
                
                <img id="modalImage" src="" alt="–°–∫—Ä–∏–Ω—à–æ—Ç" onclick="toggleZoom(event)">
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .rating-input {
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
        }
        
        .rating-input input {
            display: none;
        }
        
        .rating-input label {
            cursor: pointer;
            color: #ddd;
            font-size: 1.5rem;
            margin: 0 2px;
        }
        
        .rating-input label:hover,
        .rating-input label:hover ~ label,
        .rating-input input:checked ~ label {
            color: #ffc107;
        }
    </style>
    
    <script>
        console.log('üé¨ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ Details.cshtml');
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞–º–∏
        let currentScreenshotIndex = 0;
        const screenshots = @Html.Raw(Json.Serialize(Model.Screenshots ?? new List<string>()));
        
        console.log('üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç—ã:', screenshots);
        console.log('üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID:', '@ViewBag.CurrentUserId');
        console.log('üîê –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω:', @(User.Identity?.IsAuthenticated == true ? "true" : "false"));
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏');
            const screenshotModal = document.getElementById('screenshotModal');
            const modalImage = document.getElementById('modalImage');
            
            screenshotModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const imageSrc = button.getAttribute('data-bs-image');
                
                // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
                currentScreenshotIndex = screenshots.indexOf(imageSrc);
                if (currentScreenshotIndex === -1) currentScreenshotIndex = 0;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                loadScreenshot(currentScreenshotIndex);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑—É–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                modalImage.classList.remove('zoomed');
                modalImage.style.transform = '';
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
            screenshotModal.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modal = bootstrap.Modal.getInstance(screenshotModal);
                    modal.hide();
                }
            });
            
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            document.addEventListener('keydown', function(event) {
                if (screenshotModal.classList.contains('show')) {
                    if (event.key === 'ArrowLeft') {
                        navigateScreenshot(-1);
                    } else if (event.key === 'ArrowRight') {
                        navigateScreenshot(1);
                    }
                }
            });
        });
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
        function loadScreenshot(index) {
            const modalImage = document.getElementById('modalImage');
            const counter = document.getElementById('screenshotCounter');
            const dots = document.querySelectorAll('.screenshot-indicator .dot');
            
            if (screenshots.length === 0) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            modalImage.src = screenshots[index];
            modalImage.alt = `–°–∫—Ä–∏–Ω—à–æ—Ç ${index + 1}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            if (counter) {
                counter.textContent = `${index + 1} / ${screenshots.length}`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
            modalImage.onerror = function() {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', screenshots[index]);
                this.alt = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                this.style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                const errorMsg = document.createElement('div');
                errorMsg.className = 'alert alert-danger text-center position-absolute';
                errorMsg.style.cssText = 'top: 50%; left: 50%; transform: translate(-50%, -50%);';
                errorMsg.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                this.parentNode.appendChild(errorMsg);
            };
            
            modalImage.onload = function() {
                this.style.display = 'block';
                
                // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
                const errorMsgs = this.parentNode.querySelectorAll('.alert-danger');
                errorMsgs.forEach(msg => msg.remove());
            };
        }
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Å–∫—Ä–∏–Ω—à–æ—Ç–∞–º–∏
        function navigateScreenshot(direction) {
            currentScreenshotIndex += direction;
            
            // –¶–∏–∫–ª–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
            if (currentScreenshotIndex < 0) {
                currentScreenshotIndex = screenshots.length - 1;
            } else if (currentScreenshotIndex >= screenshots.length) {
                currentScreenshotIndex = 0;
            }
            
            loadScreenshot(currentScreenshotIndex);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑—É–º –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
            const modalImage = document.getElementById('modalImage');
            modalImage.classList.remove('zoomed');
            modalImage.style.transform = '';
        }
        
        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å–∫—Ä–∏–Ω—à–æ—Ç—É
        function goToScreenshot(index) {
            currentScreenshotIndex = index;
            loadScreenshot(currentScreenshotIndex);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑—É–º
            const modalImage = document.getElementById('modalImage');
            modalImage.classList.remove('zoomed');
            modalImage.style.transform = '';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑—É–º–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function toggleZoom(event) {
            const img = event.target;
            const modalBody = img.parentElement;
            
            if (img.classList.contains('zoomed')) {
                // –£–±–∏—Ä–∞–µ–º –∑—É–º
                img.classList.remove('zoomed');
                img.style.transform = '';
                modalBody.style.overflow = 'hidden';
            } else {
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑—É–º
                img.classList.add('zoomed');
                
                // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const rect = img.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                img.style.transform = 'scale(2)';
                img.style.transformOrigin = `${x}px ${y}px`;
                
                // –†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
                modalBody.style.overflow = 'auto';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∏–Ω–∏–∞—Ç—é—Ä –∫–∞—Ä—É—Å–µ–ª–∏
        document.addEventListener('DOMContentLoaded', function() {
            var thumbnailItems = document.querySelectorAll('.thumbnail-item');
            if (thumbnailItems.length > 0) {
                thumbnailItems.forEach(function(item) {
                    item.addEventListener('click', function() {
                        // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å active —É –≤—Å–µ—Ö –º–∏–Ω–∏–∞—Ç—é—Ä
                        thumbnailItems.forEach(function(thumb) {
                            thumb.classList.remove('active');
                        });
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å active —Ç–µ–∫—É—â–µ–π –º–∏–Ω–∏–∞—Ç—é—Ä–µ
                        this.classList.add('active');
                    });
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –º–∏–Ω–∏–∞—Ç—é—Ä—É –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–ª–∞–π–¥–∞
                var carousel = document.getElementById('screenshotsCarousel');
                if (carousel) {
                    carousel.addEventListener('slid.bs.carousel', function(event) {
                        var activeIndex = event.to;
                        
                        // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å active —É –≤—Å–µ—Ö –º–∏–Ω–∏–∞—Ç—é—Ä
                        thumbnailItems.forEach(function(thumb) {
                            thumb.classList.remove('active');
                        });
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å active —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –º–∏–Ω–∏–∞—Ç—é—Ä–µ
                        if (thumbnailItems[activeIndex]) {
                            thumbnailItems[activeIndex].classList.add('active');
                        }
                    });
                }
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            const downloadBtn = document.getElementById('download-btn');
            const downloadCountElement = document.getElementById('download-count');
            const totalDownloadsElement = document.getElementById('total-downloads');
            
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function() {
                    const authorName = this.getAttribute('data-author');
                    
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞
                    setTimeout(function() {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å—á—ë—Ç—á–∏–∫
                        if (downloadCountElement) {
                            const currentCount = parseInt(downloadCountElement.textContent) || 0;
                            downloadCountElement.textContent = currentCount + 1;
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                        if (totalDownloadsElement) {
                            const totalCount = parseInt(totalDownloadsElement.textContent) || 0;
                            totalDownloadsElement.textContent = totalCount + 1;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è –∞–≤—Ç–æ—Ä–∞
                        // –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ—Ñ–∏–ª—è, –µ—Å–ª–∏ –¥–∞
                        const currentPath = window.location.pathname;
                        if (authorName && currentPath === '/' + authorName) {
                            // –ú—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è –∞–≤—Ç–æ—Ä–∞, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
                            const profileDownloadsElement = document.getElementById('profile-total-downloads');
                            if (profileDownloadsElement) {
                                const profileDownloads = parseInt(profileDownloadsElement.textContent) || 0;
                                profileDownloadsElement.textContent = profileDownloads + 1;
                            }
                        }
                    }, 1000); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
                });
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
        function editComment(commentId, currentContent) {
            const commentDiv = document.getElementById(`comment-${commentId}`);
            const contentDiv = commentDiv.querySelector('.comment-content');
            const editForm = commentDiv.querySelector('.comment-edit-form');
            const textarea = editForm.querySelector('textarea');
            
            textarea.value = currentContent;
            contentDiv.style.display = 'none';
            editForm.style.display = 'block';
        }

        function cancelEdit(commentId) {
            const commentDiv = document.getElementById(`comment-${commentId}`);
            const contentDiv = commentDiv.querySelector('.comment-content');
            const editForm = commentDiv.querySelector('.comment-edit-form');
            
            contentDiv.style.display = 'block';
            editForm.style.display = 'none';
        }

        async function updateComment(event, commentId) {
            console.log('üîÑ –ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
            event.preventDefault();
            
            const form = event.target;
            const textarea = form.querySelector('textarea');
            const newContent = textarea.value.trim();
            
            console.log('üìù –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', {
                commentId: commentId,
                newContent: newContent,
                contentLength: newContent.length
            });
            
            if (!newContent) {
                console.log('‚ùå –û—à–∏–±–∫–∞: –ø—É—Å—Ç–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
                alert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }

            if (newContent.length > 1000) {
                console.log('‚ùå –û—à–∏–±–∫–∞: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π');
                alert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 1000 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            const requestData = {
                commentId: commentId,
                content: newContent
            };

            console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:', requestData);
            console.log('üåê URL –∑–∞–ø—Ä–æ—Å–∞:', '/Applications/UpdateComment');

            try {
                const response = await fetch('/Applications/UpdateComment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (response.ok) {
                    const responseData = await response.json();
                    console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', responseData);
                    
                    const commentDiv = document.getElementById(`comment-${commentId}`);
                    const contentDiv = commentDiv.querySelector('.comment-content p');
                    const editForm = commentDiv.querySelector('.comment-edit-form');
                    const dateElement = commentDiv.querySelector('.text-muted');
                    
                    console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã');
                    contentDiv.textContent = newContent;
                    contentDiv.parentElement.style.display = 'block';
                    editForm.style.display = 'none';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–∏–∑–º–µ–Ω–µ–Ω–æ"
                    const now = new Date();
                    const formattedDate = now.toLocaleDateString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–∏–∑–º–µ–Ω–µ–Ω–æ"
                    let editedBadge = dateElement.querySelector('.badge');
                    if (!editedBadge) {
                        editedBadge = document.createElement('span');
                        editedBadge.className = 'badge bg-secondary ms-1';
                        editedBadge.innerHTML = '<i class="fas fa-edit"></i> –∏–∑–º–µ–Ω–µ–Ω–æ';
                        dateElement.appendChild(editedBadge);
                    }
                    editedBadge.title = `–ò–∑–º–µ–Ω–µ–Ω–æ ${formattedDate}`;
                    
                    console.log('‚úÖ DOM –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                    showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                } else {
                    console.log('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    const errorText = await response.text();
                    console.log('üìÑ –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', errorText);
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        console.log('üìã –î–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (JSON):', errorData);
                        showNotification(errorData.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
                    } catch (parseError) {
                        console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—à–∏–±–∫–∏:', parseError);
                        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
                    }
                }
            } catch (error) {
                console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
                console.error('üìç Stack trace:', error.stack);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) {
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
            const scrollPosition = window.pageYOffset;

            try {
                const response = await fetch('/Applications/DeleteComment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        commentId: commentId
                    })
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const commentDiv = document.getElementById(`comment-${commentId}`);
                    if (commentDiv) {
                        commentDiv.remove();
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                        const commentsHeader = document.getElementById('comments-header');
                        console.log('Deleting comment - found header:', commentsHeader);
                        
                        if (commentsHeader) {
                            const match = commentsHeader.textContent.match(/\((\d+)\)/);
                            console.log('Current header text:', commentsHeader.textContent);
                            console.log('Match result:', match);
                            
                            if (match) {
                                const currentCount = parseInt(match[1]);
                                const newCount = Math.max(0, currentCount - 1);
                                commentsHeader.innerHTML = `<i class="fas fa-comments me-2"></i>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (${newCount})`;
                                console.log('Updated count from', currentCount, 'to', newCount);
                                
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                                const remainingComments = document.querySelectorAll('.comment');
                                console.log('Remaining comments:', remainingComments.length);
                                
                                if (remainingComments.length === 0) {
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç"
                                    const cardBody = commentsHeader.closest('.card').querySelector('.card-body');
                                    const commentForm = document.getElementById('comment-form');
                                    const noCommentsMessage = `
                                        <p class="text-muted text-center py-3" id="no-comments-message">
                                            <i class="fas fa-comment-slash fa-2x mb-2 d-block"></i>
                                            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!
                                        </p>
                                    `;
                                    
                                    if (commentForm) {
                                        commentForm.insertAdjacentHTML('afterend', noCommentsMessage);
                                    } else if (cardBody) {
                                        cardBody.insertAdjacentHTML('beforeend', noCommentsMessage);
                                    }
                                    console.log('Added no comments message');
                                }
                            }
                        } else {
                            console.error('Comments header not found!');
                        }
                        
                        showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª–µ–Ω', 'success');
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
                        setTimeout(() => {
                            window.scrollTo(0, scrollPosition);
                        }, 100);
                    } else {
                        console.error('Comment div not found:', `comment-${commentId}`);
                        showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª–µ–Ω', 'success');
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
                        setTimeout(() => {
                            window.scrollTo(0, scrollPosition);
                        }, 100);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Server error:', response.status, errorText);
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
            }
        }

        function showNotification(message, type) {
            // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            let notificationContainer = document.getElementById('notification-container');
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'notification-container';
                notificationContainer.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column-reverse; gap: 10px; pointer-events: none;';
                document.body.appendChild(notificationContainer);
            }
            
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            notification.style.cssText = 'min-width: 300px; padding-bottom: 0; pointer-events: auto; margin: 0; transform: translateX(100%); transition: transform 0.3s ease-out;';
            notification.innerHTML = `
                <div style="padding: 12px 40px 8px 16px; display: flex; align-items: center; text-align: center; min-height: 40px;">
                    <span style="flex: 1;">${message}</span>
                    <button type="button" class="btn-close" onclick="removeNotification(this)" style="position: absolute; top: 8px; right: 8px;"></button>
                </div>
                <div class="progress" style="height: 4px; border-radius: 0 0 6px 6px;">
                    <div class="progress-bar bg-${type === 'success' ? 'success' : 'danger'}" role="progressbar" style="width: 100%; transition: width 10s linear;"></div>
                </div>
            `;
            
            notificationContainer.appendChild(notification);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é progress bar
            setTimeout(() => {
                const progressBar = notification.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.style.width = '0%';
                }
            }, 100);
            
            // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            setTimeout(() => {
                removeNotification(notification);
            }, 10000);
        }
        
        function removeNotification(element) {
            const notification = element.closest ? element.closest('.alert') : element;
            if (notification && notification.parentElement) {
                notification.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                        
                        // –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π
                        const container = document.getElementById('notification-container');
                        if (container && container.children.length === 0) {
                            container.remove();
                        }
                    }
                }, 500);
            }
        }

        // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üî¢ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤');
            const commentTextarea = document.getElementById('commentTextarea');
            const charCount = document.getElementById('commentCharCount');
            const commentForm = document.getElementById('comment-form');
            
            console.log('üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:', {
                commentTextarea: !!commentTextarea,
                charCount: !!charCount,
                commentForm: !!commentForm
            });
            
            if (commentTextarea && charCount) {
                console.log('‚úÖ –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫');
                function updateCharCount() {
                    const currentLength = commentTextarea.value.length;
                    charCount.textContent = currentLength;
                    
                    if (currentLength > 950) {
                        charCount.style.color = 'red';
                    } else if (currentLength > 800) {
                        charCount.style.color = 'orange';
                    } else {
                        charCount.style.color = '';
                    }
                }
                
                commentTextarea.addEventListener('input', updateCharCount);
                updateCharCount(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                console.log('‚úÖ –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
            } else {
                console.log('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å—á–µ—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            if (commentForm) {
                console.log('‚úÖ –§–æ—Ä–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–∞–π–¥–µ–Ω–∞');
                console.log('üìã –ê—Ç—Ä–∏–±—É—Ç—ã —Ñ–æ—Ä–º—ã:', {
                    id: commentForm.id,
                    onsubmit: commentForm.getAttribute('onsubmit'),
                    'data-ajax-form': commentForm.getAttribute('data-ajax-form')
                });
            } else {
                console.log('‚ùå –§–æ—Ä–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HTML –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        function createCommentHtml(content, displayName, date, userId, commentId, profileImageUrl = null, createdAt = null, updatedAt = null) {
            const isLongComment = content.length > 300;
            const shortContent = isLongComment ? content.substring(0, 300) + "..." : content;
            const currentUserId = '@ViewBag.CurrentUserId';
            const isCurrentUser = userId === currentUserId;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–∑–º–µ–Ω–µ–Ω (—Ä–∞–∑–Ω–∏—Ü–∞ –±–æ–ª—å—à–µ 1 –º–∏–Ω—É—Ç—ã)
            let editedBadge = '';
            if (createdAt && updatedAt) {
                const created = new Date(createdAt);
                const updated = new Date(updatedAt);
                const diffMinutes = (updated - created) / (1000 * 60);
                
                if (diffMinutes > 1) {
                    const updatedFormatted = updated.toLocaleDateString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    editedBadge = `<span class="badge bg-secondary ms-1" title="–ò–∑–º–µ–Ω–µ–Ω–æ ${updatedFormatted}">
                        <i class="fas fa-edit"></i> –∏–∑–º–µ–Ω–µ–Ω–æ
                    </span>`;
                }
            }
            
            const avatarHtml = profileImageUrl ?
                `<a href="/${displayName}" style="text-decoration: none;"><img src="/${profileImageUrl}" class="rounded-circle" alt="${displayName}" style="width: 40px; height: 40px; object-fit: cover; cursor: pointer;"></a>` :
                `<a href="/${displayName}" style="text-decoration: none;"><div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px; font-weight: bold; cursor: pointer;">
                    ${displayName.substring(0, 1).toUpperCase()}
                </div></a>`;
            
            return `
                <div class="comment mb-3 p-3 rounded" id="comment-${commentId}" style="transition: all 0.3s ease; border: 1px solid transparent;">
                    <div class="d-flex">
                        <div class="flex-shrink-0 me-3">
                            ${avatarHtml}
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center">
                                    <strong><a href="/${displayName}" style="text-decoration: none; color: inherit;">${displayName}</a></strong>
                                    ${isCurrentUser ? '<span class="badge bg-primary ms-2">–ê–≤—Ç–æ—Ä</span>' : ''}
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <small class="text-muted">
                                        ${date}
                                        ${editedBadge}
                                    </small>
                                    ${isCurrentUser ? `
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <button class="dropdown-item" onclick="editComment('${commentId}', '${content.replace(/'/g, "\\'")}')">
                                                        <i class="fas fa-edit me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                                    </button>
                                                </li>
                                                <li>
                                                    <button class="dropdown-item text-danger" onclick="deleteComment('${commentId}')">
                                                        <i class="fas fa-trash me-2"></i>–£–¥–∞–ª–∏—Ç—å
                                                    </button>
                                                </li>
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="comment-content">
                                ${isLongComment ? `
                                    <p class="mb-0 comment-text-short">${shortContent}</p>
                                    <p class="mb-0 comment-text-full" style="display: none;">${content}</p>
                                    <button class="btn btn-link btn-sm p-0 mt-1 text-primary expand-comment-btn" onclick="toggleComment('${commentId}')">
                                        <i class="fas fa-chevron-down me-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
                                    </button>
                                ` : `
                                    <p class="mb-0">${content}</p>
                                `}
                            </div>
                            <div class="comment-edit-form" style="display: none;">
                                <form onsubmit="updateComment(event, ${commentId})">
                                    <div class="mb-2">
                                        <textarea class="form-control" rows="3" required maxlength="1000">${content}</textarea>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-sm btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit(${commentId})">–û—Ç–º–µ–Ω–∞</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —á–µ—Ä–µ–∑ AJAX
        async function addComment(event) {
            console.log('üöÄ –ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
            event.preventDefault();
            
            const form = event.target;
            const submitBtn = document.getElementById('submitCommentBtn');
            const textarea = document.getElementById('commentTextarea');
            const content = textarea.value.trim();
            const applicationId = form.querySelector('input[name="applicationId"]').value;
            
            console.log('üìù –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã:', {
                content: content,
                applicationId: applicationId,
                contentLength: content.length
            });
            
            if (!content) {
                console.log('‚ùå –û—à–∏–±–∫–∞: –ø—É—Å—Ç–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
                showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                return;
            }
            
            if (content.length > 1000) {
                console.log('‚ùå –û—à–∏–±–∫–∞: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π');
                showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 1000 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
            console.log('üîí –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>–û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            const requestData = {
                applicationId: parseInt(applicationId),
                content: content
            };
            
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å:', requestData);
            console.log('üåê URL –∑–∞–ø—Ä–æ—Å–∞:', '/Applications/AddComment');

            try {
                const response = await fetch('/Applications/AddComment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (response.ok) {
                    const responseData = await response.json();
                    console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', responseData);
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    textarea.value = '';
                    document.getElementById('commentCharCount').textContent = '0';
                    console.log('üßπ –§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                    const commentsHeader = document.getElementById('comments-header');
                    console.log('üî¢ –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –Ω–∞–π–¥–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫:', commentsHeader);
                    
                    if (commentsHeader) {
                        const match = commentsHeader.textContent.match(/\((\d+)\)/);
                        console.log('üìä –¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞:', commentsHeader.textContent);
                        console.log('üîç –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ —á–∏—Å–ª–∞:', match);
                        
                        if (match) {
                            const currentCount = parseInt(match[1]);
                            const newCount = currentCount + 1;
                            commentsHeader.innerHTML = `<i class="fas fa-comments me-2"></i>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (${newCount})`;
                            console.log('üìà –°—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω —Å', currentCount, '–Ω–∞', newCount);
                        } else {
                            // –ï—Å–ª–∏ –Ω–µ—Ç —Å–∫–æ–±–æ–∫, –∑–Ω–∞—á–∏—Ç —Å—á–µ—Ç—á–∏–∫ —Ä–∞–≤–µ–Ω 0
                            commentsHeader.innerHTML = `<i class="fas fa-comments me-2"></i>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (1)`;
                            console.log('üÜï –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ –≤ 1 (–ø–µ—Ä–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)');
                        }
                    } else {
                        console.error('‚ùå –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                    const commentData = responseData.comment;
                    console.log('üèóÔ∏è –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', commentData);
                    
                    const createdAt = new Date(commentData.createdAt);
                    const formattedDate = createdAt.toLocaleDateString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const newCommentHtml = createCommentHtml(
                        commentData.content,
                        commentData.user.displayName,
                        formattedDate,
                        commentData.user.id,
                        commentData.id,
                        commentData.user.profileImageUrl,
                        commentData.createdAt,
                        commentData.createdAt // –î–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è createdAt = updatedAt
                    );
                    
                    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç", –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                    const noCommentsMessage = document.getElementById('no-comments-message') ||
                                            document.querySelector('.text-muted.text-center.py-3:has(.fa-comment-slash)') ||
                                            Array.from(document.querySelectorAll('.text-muted.text-center.py-3')).find(el => el.textContent.includes('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç'));
                    if (noCommentsMessage) {
                        noCommentsMessage.remove();
                        console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç"');
                    }
                    
                    // –ù–∞—Ö–æ–¥–∏–º —Ñ–æ—Ä–º—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–µ—ë
                    const commentForm = document.getElementById('comment-form');
                    if (commentForm) {
                        commentForm.insertAdjacentHTML('afterend', newCommentHtml);
                        console.log('‚ú® –ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω –≤ DOM');
                    } else {
                        console.error('‚ùå –§–æ—Ä–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                    }
                } else {
                    console.log('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    const errorText = await response.text();
                    console.log('üìÑ –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', errorText);
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        console.log('üìã –î–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (JSON):', errorData);
                        showNotification(errorData.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
                    } catch (parseError) {
                        console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—à–∏–±–∫–∏:', parseError);
                        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
                    }
                }
            } catch (error) {
                console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
                console.error('üìç Stack trace:', error.stack);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                console.log('üîì –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
        function toggleComment(commentId) {
            const commentDiv = document.getElementById(`comment-${commentId}`);
            const shortText = commentDiv.querySelector('.comment-text-short');
            const fullText = commentDiv.querySelector('.comment-text-full');
            const expandBtn = commentDiv.querySelector('.expand-comment-btn');
            
            if (shortText.style.display === 'none') {
                // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                shortText.style.display = 'block';
                fullText.style.display = 'none';
                expandBtn.innerHTML = '<i class="fas fa-chevron-down me-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é';
            } else {
                // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                shortText.style.display = 'none';
                fullText.style.display = 'block';
                expandBtn.innerHTML = '<i class="fas fa-chevron-up me-1"></i>–°–≤–µ—Ä–Ω—É—Ç—å';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—É—Ç–µ–π –∫ –∞–≤–∞—Ç–∞—Ä–∫–∞–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Ç–∏ –∫ –∞–≤–∞—Ç–∞—Ä–∫–∞–º –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
            const avatarImages = document.querySelectorAll('.comment img[src*="~/"');
            avatarImages.forEach(img => {
                const currentSrc = img.getAttribute('src');
                if (currentSrc && currentSrc.startsWith('~/')) {
                    img.setAttribute('src', currentSrc.replace('~/', '/'));
                }
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫
            const allAvatarImages = document.querySelectorAll('.comment img.rounded-circle');
            allAvatarImages.forEach(img => {
                img.addEventListener('error', function() {
                    // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –∑–∞–º–µ–Ω—è–µ–º –µ–≥–æ –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª—ã
                    const displayName = this.getAttribute('alt') || 'U';
                    const initial = displayName.substring(0, 1).toUpperCase();
                    
                    // –°–æ–∑–¥–∞–µ–º div —Å –∏–Ω–∏—Ü–∏–∞–ª–∞–º–∏
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'rounded-circle bg-primary d-flex align-items-center justify-content-center text-white';
                    avatarDiv.style.cssText = 'width: 40px; height: 40px; font-weight: bold;';
                    avatarDiv.textContent = initial;
                    
                    // –ó–∞–º–µ–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ div
                    this.parentNode.replaceChild(avatarDiv, this);
                });
            });
        });
    </script>

    <style>
        .comment:hover {
            border-color: #007bff !important;
            box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.2);
        }
        
        .expand-comment-btn {
            text-decoration: none !important;
            font-size: 0.875rem;
        }
        
        .expand-comment-btn:hover {
            text-decoration: underline !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        #notification-container {
            max-width: 400px;
        }
        
        #notification-container .alert {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: none;
            will-change: transform, opacity;
        }
        
        body {
            overflow-x: hidden;
        }
    </style>
}